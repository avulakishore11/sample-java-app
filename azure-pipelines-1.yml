# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
 branches:
   include:
     - main
   exclude:
     - feature/*
     - develop
     - release
     - bugfix

pool:
 name: "pool-1"

 demands:
  - maven
  - java

#variables:
  # Container registry service connection established during pipeline creation
   #dockerRegistryServiceConnection: '6246b5be-821b-416d-a526-1b27edb83a94'
  #imageRepository: 'abuildpackimagev10'
  #containerRegistry: 'repo122.azurecr.io'
  #dockerfilePath: '$(Build.SourcesDirectory)/dockerfile'
  #tag: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: Build and SQ-prepare
  jobs:
  - job: Build
    displayName: Build
    steps:
     - task: SonarQubePrepare@7
       inputs:
         SonarQube: 'ado-sq-svc-connection'  # service connection in Azure DevOps
         scannerMode: 'other'                # mave/gradle or dotnet
         projectKey: 'java-8'
         projectName: 'sample-java-app'
         projectVersion:   'v1.0.0' 

     - task: Maven@4
       inputs:
         azureSubscription: 'svc-connection1'
         mavenPomFile: 'pom.xml'
         publishJUnitResults: true
         testResultsFiles: '**/surefire-reports/TEST-*.xml'
         javaHomeOption: 'JDKVersion'
         mavenVersionOption: 'Default'
         mavenAuthenticateFeed: false
         effectivePomSkip: false
         sonarQubeRunAnalysis: true
         sqMavenPluginVersionChoice: 'latest'
     - task: SonarQubeAnalyze@7
       inputs:
         jdkversion: 'JAVA_HOME_8_X64'
     - task: SonarQubePublish@7
       inputs:
         pollingTimeoutSec: '300'