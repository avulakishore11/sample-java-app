# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
 branches:
   include:
     - main
   exclude:
     - feature/*
     - develop
     - release
     - bugfix

pool:
 name: "pool-1"

 demands:
  - maven
  - java

#variables:
  # Container registry service connection established during pipeline creation
   #dockerRegistryServiceConnection: '6246b5be-821b-416d-a526-1b27edb83a94'
  #imageRepository: 'abuildpackimagev10'
  #containerRegistry: 'repo122.azurecr.io'
  #dockerfilePath: '$(Build.SourcesDirectory)/dockerfile'
  #tag: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: Build and SonarQube Analysis
  jobs:
  - job: Build
    displayName: Build
    steps:
     - task: SonarQubePrepare@7
       inputs:
          SonarQube: 'ado-sq-svc-connection' # ADO to SQ service connection
          scannerMode: 'cli'
          projectKey: 'java-17'
          projectName: 'sample-java-app'
          extraProperties: |
           sonar.branch.name=

     - task: Maven@4
       inputs:
         mavenPomFile: 'pom.xml'
         publishJUnitResults: true
         testResultsFiles: '**/surefire-reports/TEST-*.xml'
         javaHomeOption: 'JDKVersion'
         # jdkVersionOption: '17.0.16'        # align with SonarQube 10.x
         mavenAuthenticateFeed: false
         #sonarQubeRunAnalysis: true
         #sqMavenPluginVersionChoice: 'latest'
         goals: 'clean verify org.sonarsource.scanner.maven:sonar-maven-plugin:5.2.0.4988:sonar'

     - task: SonarQubePublish@7
       inputs:
         pollingTimeoutSec: '300'