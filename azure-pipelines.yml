trigger:
  branches:
    include:
      - main

variables:
  azureSubscription: 'My-Azure-Service-Connection'  # Azure RM service connection name
  azureResourceGroup: '1-5cdbb78d-playground-sandbox'
  # aksClusterName: 'my-aks-cluster'
  containerRegistry: 'mainwebappacr'
  imageName: 'myapp'
  imageTag: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: 'Build and Push Docker Image to ACR'
  jobs:
  - job: BuildPush
    displayName: 'Build and Push'
    pool:
      name: 'pool-1'
    steps:
    - task: Docker@2
      displayName: 'Login to ACR'
      inputs:
        command: login
        containerRegistry: 'myacr-service-connection' # Docker registry service connection

    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        command: build
        Dockerfile: 'dockerfile'
        tags: |
          $(containerRegistry)/$(imageName):$(imageTag)

    - task: Docker@2
      displayName: 'Push Docker Image'
      inputs:
        command: push
        tags: |
          $(containerRegistry)/$(imageName):$(imageTag)
